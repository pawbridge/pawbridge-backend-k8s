version: '3.8'

services:
  # 1. User Service
  user-service:
    image: ${DOCKER_USERNAME}/user-service:latest
    container_name: user-service
    ports:
      - "8081:8081"
    environment:
      - TZ=Asia/Seoul
      - SPRING_PROFILES_ACTIVE=dev
      - EUREKA_INSTANCE_IP_ADDRESS=${NODE4_PRIVATE_IP}
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=true
      - CONFIG_SERVER_HOST=${CONFIG_SERVER_HOST}
      - CONFIG_USERNAME=${CONFIG_USERNAME}
      - CONFIG_PASSWORD=${CONFIG_PASSWORD}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_USER_URL=${DB_USER_URL}
      - NODE1_PRIVATE_IP=${NODE1_PRIVATE_IP}
      - NODE2_PRIVATE_IP=${NODE2_PRIVATE_IP}
      - NODE3_PRIVATE_IP=${NODE3_PRIVATE_IP}
      - NODE5_PRIVATE_IP=${NODE5_PRIVATE_IP}
      - EC2_HOST_1=${EC2_HOST_1}
    deploy:
      restart_policy:
        condition: on-failure
        max_attempts: 5

  # 2. Community Service
  community-service:
    image: ${DOCKER_USERNAME}/community-service:latest
    container_name: community-service
    ports:
      - "8089:8089"
    environment:
      - TZ=Asia/Seoul
      - SPRING_PROFILES_ACTIVE=dev
      - EUREKA_INSTANCE_IP_ADDRESS=${NODE4_PRIVATE_IP}
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=true
      - CONFIG_SERVER_HOST=${CONFIG_SERVER_HOST}
      - CONFIG_USERNAME=${CONFIG_USERNAME}
      - CONFIG_PASSWORD=${CONFIG_PASSWORD}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_COMMUNITY_URL=${DB_COMMUNITY_URL}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_SECRET_KEY=${S3_SECRET_KEY}
      - S3_REGION=${S3_REGION}
      - S3_BUCKET_NAME=${S3_BUCKET_NAME}
      - NODE1_PRIVATE_IP=${NODE1_PRIVATE_IP}
      - NODE2_PRIVATE_IP=${NODE2_PRIVATE_IP}
      - NODE3_PRIVATE_IP=${NODE3_PRIVATE_IP}
      - NODE5_PRIVATE_IP=${NODE5_PRIVATE_IP}
      - EC2_HOST_1=${EC2_HOST_1}
    deploy:
      restart_policy:
        condition: on-failure
        max_attempts: 5

  # 3. Store Service
  store-service:
    image: ${DOCKER_USERNAME}/store-service:latest
    container_name: store-service
    ports:
      - "8085:8085"
    environment:
      - TZ=Asia/Seoul
      - SPRING_PROFILES_ACTIVE=dev
      - EUREKA_INSTANCE_IP_ADDRESS=${NODE4_PRIVATE_IP}
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=true
      - CONFIG_SERVER_HOST=${CONFIG_SERVER_HOST}
      - CONFIG_USERNAME=${CONFIG_USERNAME}
      - CONFIG_PASSWORD=${CONFIG_PASSWORD}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_STORE_URL=${DB_STORE_URL}
      - AWS_ACCESS_KEY=${AWS_ACCESS_KEY}
      - AWS_SECRET_KEY=${AWS_SECRET_KEY}
      - AWS_REGION=${AWS_REGION}
      - AWS_BUCKET_NAME=${AWS_BUCKET_NAME}
      - NODE1_PRIVATE_IP=${NODE1_PRIVATE_IP}
      - NODE2_PRIVATE_IP=${NODE2_PRIVATE_IP}
      - NODE3_PRIVATE_IP=${NODE3_PRIVATE_IP}
      - NODE5_PRIVATE_IP=${NODE5_PRIVATE_IP}
      - EC2_HOST_1=${EC2_HOST_1}
    deploy:
      restart_policy:
        condition: on-failure
        max_attempts: 5

  # 4. Payment Service
  payment-service:
    image: ${DOCKER_USERNAME}/payment-service:latest
    container_name: payment-service
    ports:
      - "8084:8084"
    environment:
      - TZ=Asia/Seoul
      - SPRING_PROFILES_ACTIVE=dev
      - EUREKA_INSTANCE_IP_ADDRESS=${NODE4_PRIVATE_IP}
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=true
      - CONFIG_SERVER_HOST=${CONFIG_SERVER_HOST}
      - CONFIG_USERNAME=${CONFIG_USERNAME}
      - CONFIG_PASSWORD=${CONFIG_PASSWORD}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_PAYMENT_URL=${DB_PAYMENT_URL}
      - STORE_SERVICE_URL=${STORE_SERVICE_URL}
      - NODE1_PRIVATE_IP=${NODE1_PRIVATE_IP}
      - NODE2_PRIVATE_IP=${NODE2_PRIVATE_IP}
      - NODE3_PRIVATE_IP=${NODE3_PRIVATE_IP}
      - NODE5_PRIVATE_IP=${NODE5_PRIVATE_IP}
      - EC2_HOST_1=${EC2_HOST_1}
    deploy:
      restart_policy:
        condition: on-failure
        max_attempts: 5
