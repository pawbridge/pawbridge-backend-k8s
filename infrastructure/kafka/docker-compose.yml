version: '3.8'

services:
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper
    ports:
      - "2181:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    volumes:
      - zookeeper-data:/var/lib/zookeeper/data
      - zookeeper-logs:/var/lib/zookeeper/log
    networks:
      default:
        aliases:
          - zookeeper

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka-broker
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-broker:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:29092,PLAINTEXT_HOST://0.0.0.0:9092
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "false" # Î™ÖÏãúÏ†ÅÏúºÎ°ú ÏÉùÏÑ±ÌïòÎØÄÎ°ú falseÎ°ú Î≥ÄÍ≤Ω
    volumes:
      - kafka-data:/var/lib/kafka/data
    networks:
      default:
        aliases:
          - kafka-broker

  # Kafka TopicÏùÑ Î™ÖÏãúÏ†ÅÏúºÎ°ú ÏÉùÏÑ±ÌïòÎäî ÏÑúÎπÑÏä§
  kafka-topic-creator:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka-topic-creator
    depends_on:
      - kafka
    command: >
      bash -c "
        echo 'Waiting for Kafka to be ready...' &&
        cub kafka-ready -b kafka-broker:29092 1 30 &&
        echo 'Kafka is ready!' &&
        
        echo 'Creating Kafka topics...' &&
        kafka-topics --create --if-not-exists --bootstrap-server kafka-broker:29092 --partitions 1 --replication-factor 1 --topic connect_configs --config cleanup.policy=compact &&
        kafka-topics --create --if-not-exists --bootstrap-server kafka-broker:29092 --partitions 1 --replication-factor 1 --topic connect_offsets --config cleanup.policy=compact &&
        kafka-topics --create --if-not-exists --bootstrap-server kafka-broker:29092 --partitions 1 --replication-factor 1 --topic connect_statuses --config cleanup.policy=compact &&
        kafka-topics --create --if-not-exists --bootstrap-server kafka-broker:29092 --partitions 1 --replication-factor 1 --topic schema-changes.animal &&
        kafka-topics --create --if-not-exists --bootstrap-server kafka-broker:29092 --partitions 1 --replication-factor 1 --topic animal --config cleanup.policy=compact &&
        kafka-topics --create --if-not-exists --bootstrap-server kafka-broker:29092 --partitions 1 --replication-factor 1 --topic animal.pawbridge_animal.animals &&
        kafka-topics --create --if-not-exists --bootstrap-server kafka-broker:29092 --partitions 1 --replication-factor 1 --topic animal.animals &&
        kafka-topics --create --if-not-exists --bootstrap-server kafka-broker:29092 --partitions 1 --replication-factor 1 --topic pawbridge.animal.outbox.events &&
        kafka-topics --create --if-not-exists --bootstrap-server kafka-broker:29092 --partitions 1 --replication-factor 1 --topic pawbridge.community.outbox.events &&
        kafka-topics --create --if-not-exists --bootstrap-server kafka-broker:29092 --partitions 1 --replication-factor 1 --topic schema-changes.store &&
        kafka-topics --create --if-not-exists --bootstrap-server kafka-broker:29092 --partitions 1 --replication-factor 1 --topic schema-changes.payment &&
        kafka-topics --create --if-not-exists --bootstrap-server kafka-broker:29092 --partitions 1 --replication-factor 1 --topic store.outbox.events &&
        kafka-topics --create --if-not-exists --bootstrap-server kafka-broker:29092 --partitions 1 --replication-factor 1 --topic payment.events &&
        kafka-topics --create --if-not-exists --bootstrap-server kafka-broker:29092 --partitions 1 --replication-factor 1 --topic schema-changes.user.outbox &&
        kafka-topics --create --if-not-exists --bootstrap-server kafka-broker:29092 --partitions 1 --replication-factor 1 --topic user.favorite.events &&
        kafka-topics --create --if-not-exists --bootstrap-server kafka-broker:29092 --partitions 1 --replication-factor 1 --topic user.compensation.events &&

        echo 'Topics created successfully! This container will now exit.'
      "
    networks:
      default:
        aliases:
          - kafka-topic-creator
    restart: "no"

  kafka-connect:
    build:
      context: .
      dockerfile: Dockerfile
    image: pawbridge/kafka-connect:latest
    container_name: kafka-connect
    depends_on:
      - kafka-topic-creator # ÌÜ†ÌîΩÏù¥ ÏÉùÏÑ±Îêú ÌõÑ Ïã§ÌñâÎêòÎèÑÎ°ù ÏùòÏ°¥ÏÑ± Ï∂îÍ∞Ä
    ports:
      - "8083:8083"
    environment:
      CONNECT_BOOTSTRAP_SERVERS: kafka-broker:29092
      CONNECT_GROUP_ID: 1
      CONNECT_CONFIG_STORAGE_TOPIC: connect_configs
      CONNECT_OFFSET_STORAGE_TOPIC: connect_offsets
      CONNECT_STATUS_STORAGE_TOPIC: connect_statuses
      CONNECT_CONFIG_STORAGE_REPLICATION_FACTOR: 1
      CONNECT_OFFSET_STORAGE_REPLICATION_FACTOR: 1
      CONNECT_STATUS_STORAGE_REPLICATION_FACTOR: 1
      CONNECT_REST_ADVERTISED_HOST_NAME: kafka-connect
      CONNECT_KEY_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      CONNECT_VALUE_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      CONNECT_PLUGIN_PATH: /usr/share/java,/usr/share/confluent-hub-components
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8083/"]
      interval: 10s
      timeout: 5s
      retries: 30
    networks:
      default:
        aliases:
          - kafka-connect

  connector-init:
    image: curlimages/curl:latest
    container_name: debezium-connector-init
    depends_on:
      - kafka-connect
    command:
      - sh
      - -c
      - |
        echo "‚è≥ Waiting for Kafka Connect to be ready..."
        for i in $$(seq 1 36); do
          if curl -f -s http://kafka-connect:8083/connectors > /dev/null 2>&1; then
            echo "‚úÖ Kafka Connect is ready!"
            break
          fi
          echo "Attempt $$i/36: Kafka Connect not ready yet, waiting 5 seconds..."
          sleep 5
        done
        echo "üì° Registering Connectors..."
        CONNECTORS="community-outbox-connector.json animal-outbox-connector.json animal-animals-connector.json elasticsearch-sink-connector.json store-outbox-connector.json payment-outbox-connector.json store-es-sink-connector.json user-outbox-connector.json"
        for CONNECTOR_FILE in $$CONNECTORS; do
          echo ""
          echo "üîÑ Registering $$CONNECTOR_FILE..."
          RESPONSE=$$(curl -s -w "\n%{http_code}" -X POST http://kafka-connect:8083/connectors \
            -H "Content-Type: application/json" \
            -d @/connectors/$$CONNECTOR_FILE)
          HTTP_CODE=$$(echo "$$RESPONSE" | tail -n1)
          BODY=$$(echo "$$RESPONSE" | head -n-1)
          if [ "$$HTTP_CODE" = "201" ]; then
            echo "‚úÖ $$CONNECTOR_FILE registered successfully! (HTTP $$HTTP_CODE)"
          elif [ "$$HTTP_CODE" = "409" ]; then
            echo "‚ÑπÔ∏è  $$CONNECTOR_FILE already exists (HTTP $$HTTP_CODE)"
          else
            echo "‚ùå Failed to register $$CONNECTOR_FILE (HTTP $$HTTP_CODE)"
            echo "$$BODY"
          fi
        done
        echo ""
        echo "‚úÖ All connectors registration completed!"
    volumes:
      - ./connectors:/connectors
    networks:
      default:
        aliases:
          - connector-init
    restart: "no"

volumes:
  zookeeper-data:
    driver: local
  zookeeper-logs:
    driver: local
  kafka-data:
    driver: local

networks:
  default:
    external: true
    name: pawbridge-network
